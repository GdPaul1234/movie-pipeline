# How to generate resources for the `segments_detector` tests?

## 1. Generating the video

1. Install and launch [stable-diffusion-webui-docker](https://github.com/AbdBarho/stable-diffusion-webui-docker) and follows instructions to install AUTOMATIC1111.

2. Download the [playground-v2.fp16.safetensors](https://huggingface.co/playgroundai/playground-v2-1024px-aesthetic/blob/main/playground-v2.fp16.safetensors) Stable Diffusion checkpoint and puts it under `#{stable-diffusion-webui-docker folder}/data/models/Stable-diffusion`.

3. Install the [sd-webui-deforum](https://github.com/deforum-art/sd-webui-deforum) extension.

4. Go to the `Deforum` tab, fill in the `Settings File` input with the path of `tests\movie_pipeline\ressources\features\segments_detector\20240728202517_settings.txt`, then click on `Load all settings`.

5. Click on `Generate` and copy the video under this folder.

## 2. Generating the audio

1. Install and launch [MusicGPT](https://github.com/gabotechs/MusicGPT). It will take some times to load the first time because it downloads the model for generating audio from text prompt.

2. Follows these prompt partially generated by Llama3.1:8b:

> **Introduction (5 seconds, music_001.wav)**
>
> * Prompt : "A background music that is engaging and optimistic, with a touch of joy and confidence. A light rhythm and airy melody. Use the following instruments: piano, acoustic guitar, flute, and light sound effects to give a sense of openness."
> * Generate a 5-second background music with these characteristics.
>
>
> **Publicity 1 (5 seconds, music_002.wav)**
>
> * Prompt : "A product music that helps achieve well-being. A energetic and motivating rhythm, with a mix of percussion and synths to give an impression of effectiveness. Use the following instruments: drums, electric bass, keyboards, and sound effects to add a touch of power."
> * Generate a 5-second product music with these characteristics.
>
> **Main Content (10 seconds, music_003.wav)**
>
> * Prompt : "A music that reflects the experiences and advice of the person. A slower and more melancholic rhythm, with a mix of acoustic instruments to give an impression of intimacy. Use the following instruments: piano, acoustic guitar, and light sound effects to add a touch of personality."
> * Generate a 10-second main content music with these characteristics.
>
> **Publicity 2 (5 seconds, music_004.wav)**
>
> * Prompt : "A product music that helps achieve well-being, but with a calmer and more peaceful tone. Use the following instruments: drums, electric bass, keyboards, and sound effects to add a touch of serenity."
> * Generate a 5-second product music with these characteristics.
>
> **Conclusion (5 seconds, music_005.wav)**
>
> * Prompt : "A slightly modified version of the initial background music, but with a more confident and motivating tone. Use the following instruments: piano, acoustic guitar, and light sound effects to give a sense of success."
> * Generate a 5-second background music with these characteristics.

## 3. Generating dialogs

Using [openedai-speech](https://github.com/matatonic/openedai-speech) and after configuring piper, make requests to the
`/v1/audio/speech` endpoint to generate the voice-overs with the following POST bodies (`application/json`):

* For the French (FR) voice-over:

    ```json
    {
    "input": "Imaginez-vous dans une situation où vous vous sentez vraiment confiant et capable. C'est possible ! Et nous allons vous montrer comment. Essayez maintenant notre nouveau produit conçu pour vous faire atteindre vos objectifs. Chaque jour, nous pouvons prendre des décisions qui nous rendent heureux. Prendre soin de notre santé, être avec les personnes qu'on aime, se divertir. Découvrez maintenant des produits Entreprise qui répondent à vos attentes ! Vous pouvez avoir une vie parfaite en prenant soin de vous-même, et en vivant une vie équilibrée !",
    "model": "tts-1",
    "voice": "siwis",
    "speed": 1.2
    }
    ```

* For the English (EN) voice-over:

    ```json
    {
    "input": "Imagine yourself in a situation where you feel truly confident and capable. It's possible! And we'll show you how to make it happen. Try our new product now, designed to help you achieve your goals. Every day, we have the power to make choices that bring us joy. Take care of our health, be with the people we love, have fun. Discover products from Company that meet your expectations! You can have a perfect life by taking care of yourself and living in balance!",
    "model": "tts-1",
    "voice": "alloy",
    "speed": 0.7
    }
    ```

Save them to `.\src\voiceover_#{language}.mp3`.

## 4. Adding logo and ad breaks

## 5. Edit and render the videos

* Open `segments_detector test video.kdenlive` in Kdenlive.

* Render the project with the EN track muted, into `segments_detector test video_FR.mp4`

* Render the project with the FR track muted, into `segments_detector test video_EN.mp4`

* Merge the audio tracks with the following ffmpeg commands:

  ```sh
  ffmpeg \
  -i "paths/to/segments_detector test video_FR.mp4" \
  -i "paths/to/segments_detector test video_FR.mp4" \
  -i "paths/to/segments_detector test video_EN.mp4" \
  -map 0:0 -c:v copy -metadata:s:v:0 language=und -map 1:1 -c:a copy -metadata:s:a:0 language=fra -disposition:a:0 default -map 2:1 -c:a copy -metadata:s:a:1 language=eng \
  -disposition:a:1 0 \
  -y \
  "paths/to/segments_detector test video.mp4"
  ```

* Move the rendered video in `tests\movie_pipeline\ressources\features\segments_detector\segments_detector test video.mp4`
